BTEQ 16.20.00.07 (32-bit) Sat Jan 28 01:03:02 2023 PID: 18743754
 
+---------+---------+---------+---------+---------+---------+---------+----

LOGON tdtp01s2/usr_carga_desa,

 *** Logon successfully completed.
 *** Teradata Database Release is 16.20.53.55                   
 *** Teradata Database Version is 16.20.53.55                     
 *** Transaction Semantics are BTET.
 *** Session Character Set Name is 'ASCII'.
 
 *** Total elapsed time was 1 second.
 
+---------+---------+---------+---------+---------+---------+---------+----

DATABASE bddwedqd;

 *** New default database accepted. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----

.SET FORMAT OFF;
+---------+---------+---------+---------+---------+---------+---------+----
.SET WIDTH 32000;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.SET SEPARATOR '|';
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.SET TITLEDASHES OFF;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

SEL CURRENT_TIMESTAMP;

 *** Query completed. One row found. One column returned. 
 *** Total elapsed time was 1 second.

            Current TimeStamp(6)
2023-01-28 00:48:08.920000-05:00

+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

/*========================================================================================= */
/**********************************TRANSACCIONALES******************************************/
/*========================================================================================= */

/*******************Obtiene última dj form 0601********************************************/


/**********Obtiene Última DJ Form 0601 ********************************/

SELECT 1 FROM  dbc.TablesV WHERE databasename = 'bddwestgd' AND TableName = 'tmp093168_udjkpigr3';

 *** Query completed. One row found. One column returned. 
 *** Total elapsed time was 1 second.

   1
   1

+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF activitycount = 0 THEN .GOTO ok
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

DROP TABLE bddwestgd.tmp093168_udjkpigr3;

 *** Table has been dropped. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF ERRORCODE <> 0 THEN .GOTO error_shell;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.label ok;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-


CREATE MULTISET TABLE bddwestgd.tmp093168_udjkpigr3 as
(
  SELECT t2.t03nabono,t2.t03norden,t2.t03formulario,
         t2.t03lltt_ruc,t2.t03periodo,t2.t03f_presenta 
  FROM 
  (
    SELECT t03periodo,
           t03lltt_ruc,
           t03formulario,
           MAX(t03f_presenta) as t03f_presenta,
           MAX(t03nresumen) as t03nresumen,
           MAX(t03norden)  as t03norden
    FROM bddwestgd.t03djcab
    WHERE t03formulario = '0601' 
    AND t03periodo BETWEEN '202201' and '202212'
    AND t03f_presenta <=DATE '2100-01-01'
    GROUP BY 1,2,3
  ) AS t1 
  INNER JOIN bddwestgd.t03djcab t2 ON t2.t03periodo = t1.t03periodo 
  AND t2.t03lltt_ruc = t1.t03lltt_ruc
  AND t2.t03formulario = t1.t03formulario
  AND t2.t03f_presenta = t1.t03f_presenta
  AND t2.t03nresumen = t1.t03nresumen
  AND t2.t03norden = t1.t03norden
)
WITH DATA NO PRIMARY INDEX;

 *** Table has been created. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORCODE <> 0 THEN .GOTO error_shell;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-


/******************Obtiene periodos declarados en el PLAME***************************/

SELECT 1 FROM  dbc.TablesV WHERE databasename = 'bddwestgd' AND TableName = 'tmp093168_kpigr3_periodos_compag';

 *** Query completed. One row found. One column returned. 
 *** Total elapsed time was 1 second.

   1
   1

+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF activitycount = 0 THEN .GOTO ok
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

DROP TABLE bddwestgd.tmp093168_kpigr3_periodos_compag;

 *** Table has been dropped. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF ERRORCODE <> 0 THEN .GOTO error_shell;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.label ok;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

CREATE MULTISET TABLE bddwestgd.tmp093168_kpigr3_periodos_compag AS
(

  SELECT DISTINCT
    CASE WHEN x0.cod_tip_doc_ide = '06' 
         THEN x2.ddp_numruc
    ELSE  x3.dds_numruc END AS num_rucs,
      x0.num_ruc,
      x0.num_paq as num_nabono,
      x0.formulario as cod_formul,
      x0.norden as num_orden,
      x0.per_decla
  FROM bddwestgd.t4583com_pag x0 
  INNER JOIN bddwestgd.tmp093168_udjkpigr3 x1 
  ON  x1.t03lltt_ruc = x0.num_ruc
  AND x1.t03nabono = x0.num_paq
  AND x1.t03formulario = x0.formulario 
  AND x1.t03norden = x0.norden
  LEFT JOIN bddwestgd.ddp x2 
  ON x0.num_doc_ide=x2.ddp_numruc AND x0.cod_tip_doc_ide='06'
  LEFT JOIN bddwestgd.dds x3 
  ON x0.num_doc_ide=x3.dds_nrodoc AND cast(cast(x0.cod_tip_doc_ide AS int) as varchar(2))=x3.dds_docide
  WHERE x0.per_decla BETWEEN '202201' AND '202212' 
  AND x0.formulario = '0601'
  AND x0.ind_com_pag = 'D'
  AND x0.mto_servicio IS NOT NULL
  AND  num_rucs IS NOT NULL

) WITH DATA NO PRIMARY INDEX;

 *** Table has been created. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORCODE <> 0 THEN .GOTO error_shell;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-


/**************************Obtiene Última DJ de Form 0616 ********************************/

SELECT 1 FROM  dbc.TablesV WHERE databasename = 'bddwestgd' AND TableName = 'tmp093168_udj_f616_kpigr3';

 *** Query completed. One row found. One column returned. 
 *** Total elapsed time was 1 second.

   1
   1

+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF activitycount = 0 THEN .GOTO ok
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

DROP TABLE bddwestgd.tmp093168_udj_f616_kpigr3;

 *** Table has been dropped. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF ERRORCODE <> 0 THEN .GOTO error_shell;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.label ok;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
CREATE MULTISET TABLE bddwestgd.tmp093168_udj_f616_kpigr3 as
(
  SELECT t2.t03nabono,t2.t03norden,t2.t03formulario,
         t2.t03lltt_ruc,t2.t03periodo,t2.t03f_presenta 
  FROM 
  (
  SELECT t03periodo,
         t03lltt_ruc,
         t03formulario,
         MAX(t03f_presenta) as t03f_presenta,
         MAX(t03nresumen) as t03nresumen,
         MAX(t03norden)  as t03norden
  FROM bddwestgd.t03djcab
  WHERE t03formulario = '0616' 
   AND t03periodo BETWEEN '202201' and '202212'
    AND t03f_presenta <=DATE '2100-01-01'
  GROUP BY 1,2,3
  ) AS t1 
  INNER JOIN bddwestgd.t03djcab t2 ON t2.t03periodo = t1.t03periodo 
  AND t2.t03lltt_ruc = t1.t03lltt_ruc
  AND t2.t03formulario = t1.t03formulario
  AND t2.t03f_presenta = t1.t03f_presenta
  AND t2.t03nresumen = t1.t03nresumen
  AND t2.t03norden = t1.t03norden
)
WITH DATA NO PRIMARY INDEX;

 *** Table has been created. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORCODE <> 0 THEN .GOTO error_shell;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-


/*************** Obtiene periodos declarados en F0616****************************************/

SELECT 1 FROM  dbc.TablesV WHERE databasename = 'bddwestgd' AND TableName = 'tmp093168_kpigr3_periodos_f0616';

 *** Query completed. One row found. One column returned. 
 *** Total elapsed time was 1 second.

   1
   1

+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF activitycount = 0 THEN .GOTO ok
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

DROP TABLE bddwestgd.tmp093168_kpigr3_periodos_f0616;

 *** Table has been dropped. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF ERRORCODE <> 0 THEN .GOTO error_shell;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.label ok;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

CREATE MULTISET TABLE bddwestgd.tmp093168_kpigr3_periodos_f0616 as
(
  SELECT  DISTINCT x0.num_docide_dec,
          x0.num_docide_ret,
          x0.num_paq as num_nabono,
          x0.formulario as cod_formul,
          x0.norden as num_orden,
          x0.per_periodo 
  FROM bddwestgd.t1209f616rddet x0, bddwestgd.tmp093168_udj_f616_kpigr3 x1
  WHERE x0.tip_docide_dec = '6'
  AND x0.per_periodo between '202201' and '202212'
  AND x0.formulario = '0616'
  AND x0.tip_cp = '99'
  AND x1.t03nabono = x0.num_paq
  AND x1.t03formulario = x0.formulario 
  AND x1.t03norden = x0.norden
  AND LENGTH(x0.num_docide_ret) = '11'
) WITH DATA NO PRIMARY INDEX;

 *** Table has been created. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
;

 *** Null statement accepted. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORCODE <> 0 THEN .GOTO error_shell;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-


/**************Union de Periodos Plame con Periodos f0616*********************************/

SELECT 1 FROM  dbc.TablesV WHERE databasename = 'bddwestgd' AND TableName = 'tmp093168_kpigr03_detcnt_tr';

 *** Query completed. One row found. One column returned. 
 *** Total elapsed time was 1 second.

   1
   1

+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF activitycount = 0 THEN .GOTO ok
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

DROP TABLE bddwestgd.tmp093168_kpigr03_detcnt_tr;

 *** Table has been dropped. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF ERRORCODE <> 0 THEN .GOTO error_shell;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.label ok;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

CREATE MULTISET TABLE bddwestgd.tmp093168_kpigr03_detcnt_tr AS
(
  
 SELECT  TRIM(num_docide_dec) as num_ruc,
         TRIM(num_docide_ret) as num_docide_empl,
         num_nabono,
         cod_formul,
         num_orden,
         per_periodo as per_decla
  FROM bddwestgd.tmp093168_kpigr3_periodos_f0616
  UNION
  SELECT 
         TRIM(num_rucs),
         TRIM(num_ruc) as num_docide_empl,
         num_nabono,
         cod_formul,
         num_orden,
         per_decla
  FROM bddwestgd.tmp093168_kpigr3_periodos_compag
)WITH DATA NO PRIMARY INDEX;

 *** Table has been created. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORCODE <> 0 THEN .GOTO error_shell;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

/*======================================================================================*/
/****************Genera Detalles con Indicador de Presentación***************************/

-------1. Detalle de Periodos  en transaccional

SELECT 1 FROM  dbc.TablesV WHERE databasename = 'bddwestgd' AND TableName = 'tmp093168_kpigr03_detcntpertr';

 *** Query completed. One row found. One column returned. 
 *** Total elapsed time was 1 second.

   1
   1

+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF activitycount = 0 THEN .GOTO ok
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

DROP TABLE bddwestgd.tmp093168_kpigr03_detcntpertr;

 *** Table has been dropped. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF ERRORCODE <> 0 THEN .GOTO error_shell;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.label ok;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
CREATE MULTISET TABLE bddwestgd.tmp093168_kpigr03_detcntpertr
AS(
SELECT 
    DISTINCT x0.num_ruc,
    COALESCE(x1.ind_presdj,0) as ind_presdj,
        x0.num_docide_empl,
        x0.num_nabono,
        x0.cod_formul,
        x0.num_orden,
        x0.per_decla
FROM bddwestgd.tmp093168_kpigr03_detcnt_tr x0
LEFT JOIN bddwestgd.tmp093168_kpiperindj x1 on x0.num_ruc=x1.num_ruc
INNER JOIN bddwestgd.dds x2 ON x0.num_ruc=x2.dds_numruc 
WHERE x2.dds_domici = '1'  AND x2.dds_docide IN ('1','2','3','4','5','7','8') 
) WITH DATA NO PRIMARY INDEX ;

 *** Table has been created. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORCODE <> 0 THEN .GOTO error_shell;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-


-------2. Detalle de Periodos en Archivo Personalizado Fvirtual

SELECT 1 FROM  dbc.TablesV WHERE databasename = 'bddwestgd' AND TableName = 'tmp093168_kpigr03_detcntperfv';

 *** Query completed. One row found. One column returned. 
 *** Total elapsed time was 1 second.

   1
   1

+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF activitycount = 0 THEN .GOTO ok
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

DROP TABLE bddwestgd.tmp093168_kpigr03_detcntperfv;

 *** Table has been dropped. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF ERRORCODE <> 0 THEN .GOTO error_shell;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.label ok;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
CREATE MULTISET TABLE bddwestgd.tmp093168_kpigr03_detcntperfv
AS
(
  SELECT DISTINCT x1.num_ruc,COALESCE(x1.ind_presdj,0) as ind_presdj,
          x0.num_doc,
          x0.periodo
  FROM bddwestgd.T5376CAS108 x0
  INNER JOIN bddwestgd.tmp093168_kpiperindj x1 ON x0.num_sec = x1.num_sec
  --WHERE x0.tip_doc='06'
) WITH DATA NO PRIMARY INDEX ;

 *** Table has been created. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORCODE <> 0 THEN .GOTO error_shell;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-


-------3. Detalle de Periodos en Archivo Personalizado MongoDB

SELECT 1 FROM  dbc.TablesV WHERE databasename = 'bddwestgd' AND TableName = 'tmp093168_kpigr03_detcntpermdb';

 *** Query completed. One row found. One column returned. 
 *** Total elapsed time was 1 second.

   1
   1

+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF activitycount = 0 THEN .GOTO ok
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

DROP TABLE bddwestgd.tmp093168_kpigr03_detcntpermdb;

 *** Table has been dropped. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF ERRORCODE <> 0 THEN .GOTO error_shell;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.label ok;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

CREATE MULTISET TABLE bddwestgd.tmp093168_kpigr03_detcntpermdb
AS(
  SELECT DISTINCT x1.num_ruc,COALESCE(x1.ind_presdj,0) as ind_presdj,
          x0.num_doc, x0.num_perservicio
  FROM bddwestgd.T5376CAS108_MONGODB x0
  INNER JOIN bddwestgd.tmp093168_kpiperindj x1 ON x0.num_sec = x1.num_sec
  --WHERE x0.COD_TIPDOC='06'
) WITH DATA NO PRIMARY INDEX ;

 *** Table has been created. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORCODE <> 0 THEN .GOTO error_shell;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

/*======================================================================================*/
/************************Conteo para insercion en DETKPI ********************************/

---------1. Conteo transaccional

SELECT 1 FROM  dbc.TablesV WHERE databasename = 'bddwestgd' AND TableName = 'tmp093168_kpigr03_cnorigen';

 *** Query completed. One row found. One column returned. 
 *** Total elapsed time was 1 second.

   1
   1

+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF activitycount = 0 THEN .GOTO ok
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

DROP TABLE bddwestgd.tmp093168_kpigr03_cnorigen;

 *** Table has been dropped. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF ERRORCODE <> 0 THEN .GOTO error_shell;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.label ok;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
CREATE MULTISET TABLE bddwestgd.tmp093168_kpigr03_cnorigen AS
(
  SELECT ind_presdj,count(per_decla) as cant_per_origen
  FROM bddwestgd.tmp093168_kpigr03_detcntpertr
  GROUP BY 1
) WITH DATA NO PRIMARY INDEX;

 *** Table has been created. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORCODE <> 0 THEN .GOTO error_shell;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

---------2. Conteo en FVirtual

SELECT 1 FROM  dbc.TablesV WHERE databasename = 'bddwestgd' AND TableName = 'tmp093168_kpigr03_cndestino1';

 *** Query completed. One row found. One column returned. 
 *** Total elapsed time was 1 second.

   1
   1

+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF activitycount = 0 THEN .GOTO ok
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

DROP TABLE bddwestgd.tmp093168_kpigr03_cndestino1;

 *** Table has been dropped. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF ERRORCODE <> 0 THEN .GOTO error_shell;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.label ok;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
CREATE MULTISET TABLE bddwestgd.tmp093168_kpigr03_cndestino1 AS
(
  SELECT ind_presdj,count(periodo) as cant_per_destino1
  FROM bddwestgd.tmp093168_kpigr03_detcntperfv
  GROUP BY 1
) WITH DATA NO PRIMARY INDEX;

 *** Table has been created. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORCODE <> 0 THEN .GOTO error_shell;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-


--------3 Conteo en MongoDB

SELECT 1 FROM  dbc.TablesV WHERE databasename = 'bddwestgd' AND TableName = 'tmp093168_kpigr03_cndestino2';

 *** Query completed. One row found. One column returned. 
 *** Total elapsed time was 1 second.

   1
   1

+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF activitycount = 0 THEN .GOTO ok
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

DROP TABLE bddwestgd.tmp093168_kpigr03_cndestino2 ;

 *** Table has been dropped. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF ERRORCODE <> 0 THEN .GOTO error_shell;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.label ok;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
CREATE MULTISET TABLE bddwestgd.tmp093168_kpigr03_cndestino2 AS
(
  SELECT ind_presdj,count(num_perservicio) as cant_per_destino2
  FROM bddwestgd.tmp093168_kpigr03_detcntpermdb
  GROUP BY 1
) WITH DATA NO PRIMARY INDEX;

 *** Table has been created. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORCODE <> 0 THEN .GOTO error_shell;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-


/********************INSERT EN TABLA FINAL***********************************/

  DELETE FROM bddwedqd.T11908DETKPITRIBINT 
  WHERE COD_KPI='K003012022' AND FEC_CARGA=CURRENT_DATE;

 *** Delete completed. No rows removed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

  .IF ERRORCODE <> 0 THEN .GOTO error_shell;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

  INSERT INTO bddwedqd.T11908DETKPITRIBINT 
  (COD_PER,IND_PRESDJ,COD_KPI,FEC_CARGA,CNT_REGORIGEN,CNT_REGIDESTINO)
  SELECT  '2022',
          z.ind_presdj,
         'K003012022',
          CURRENT_DATE,
          SUM(z.cant_origen),
          SUM(z.cant_destino)
  FROM
    (
      SELECT
             x0.ind_presdj,
             x0.cant_per_origen as cant_origen,
             coalesce(x1.cant_per_destino1,0) as cant_destino
      FROM bddwestgd.tmp093168_kpigr03_cnorigen x0
      LEFT JOIN bddwestgd.tmp093168_kpigr03_cndestino1 x1 
      ON x0.ind_presdj=x1.ind_presdj
    ) z
  GROUP BY 1,2,3,4
  ;

 *** Insert completed. No rows added. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

  .IF ERRORCODE <> 0 THEN .GOTO error_shell;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

  DELETE FROM bddwedqd.T11908DETKPITRIBINT 
  WHERE COD_KPI='K003022022' AND FEC_CARGA=CURRENT_DATE;

 *** Delete completed. No rows removed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

  .IF ERRORCODE <> 0 THEN .GOTO error_shell;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

  INSERT INTO bddwedqd.T11908DETKPITRIBINT 
  (COD_PER,IND_PRESDJ,COD_KPI,FEC_CARGA,CNT_REGORIGEN,CNT_REGIDESTINO)
  SELECT  '2022',
          z.ind_presdj,
          'K003022022',
          CURRENT_DATE,
          SUM(z.cant_origen),
          SUM(z.cant_destino)
  FROM
    (
      SELECT x0.ind_presdj,
             x0.cant_per_destino1 AS cant_origen,
             coalesce(x1.cant_per_destino2,0) AS cant_destino
      FROM bddwestgd.tmp093168_kpigr03_cndestino1 x0
      LEFT JOIN bddwestgd.tmp093168_kpigr03_cndestino2 x1 
      ON x0.ind_presdj=x1.ind_presdj
    ) z
  GROUP BY 1,2,3,4
  ;

 *** Insert completed. No rows added. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

  .IF ERRORCODE <> 0 THEN .GOTO error_shell;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
 
/*=============================================================================*/
/***********************Genera Detalle de Diferencias**************************/
/*=============================================================================*/ 

  .EXPORT FILE /work1/teradata/dat/093168/DIFF_K003012022_20230128.unl;
 *** Warning: No data format given. Assuming REPORT carries over.
 *** To reset export, type .EXPORT RESET
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

  SELECT 
     DISTINCT 'K003012022' as cod_kpi,
       y0.num_ruc,
     y0.ind_presdj,
         y0.num_docide_empl,
         y0.num_nabono,
         y0.cod_formul,
         y0.num_orden,
         y0.per_decla
   FROM bddwestgd.tmp093168_kpigr03_detcntpertr y0
   INNER JOIN
   (
     SELECT DISTINCT num_ruc,ind_presdj,num_docide_empl,
                     SUBSTR(per_decla,5,2)||SUBSTR(per_decla,1,4) as per_decla
     FROM bddwestgd.tmp093168_kpigr03_detcntpertr
     EXCEPT ALL
     SELECT num_ruc,ind_presdj,num_doc,periodo 
     FROM bddwestgd.tmp093168_kpigr03_detcntperfv
   ) y1 
   ON y0.num_ruc=y1.num_ruc 
   AND y0.ind_presdj=y1.ind_presdj 
   AND y0.num_docide_empl=y1.num_docide_empl
   AND SUBSTR(y0.per_decla,5,2)||SUBSTR(y0.per_decla,1,4)=y1.per_decla;

 *** Query completed. No rows found. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

 .IF ERRORCODE <> 0 THEN .GOTO error_shell;.
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

 .EXPORT RESET;
 *** Output returned to console.
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-


   .EXPORT FILE /work1/teradata/dat/093168/DIFF_K003022022_20230128.unl;
 *** Warning: No data format given. Assuming REPORT carries over.
 *** To reset export, type .EXPORT RESET
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
    
      LOCK ROW FOR ACCESS
   SELECT  DISTINCT 'K003022022' as cod_kpi,
           y0.num_ruc,
           y0.ind_presdj,
         y0.num_doc,
         y0.periodo  
   FROM
   (
     SELECT num_ruc,ind_presdj,num_doc,periodo 
     FROM bddwestgd.tmp093168_kpigr03_detcntperfv
     EXCEPT ALL
     SELECT num_ruc,ind_presdj,num_doc,num_perservicio
     FROM bddwestgd.tmp093168_kpigr03_detcntpermdb
   ) y0;

 *** Query completed. No rows found. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
  .IF ERRORCODE <> 0 THEN .GOTO error_shell;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

 .EXPORT RESET;
 *** Output returned to console.
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

/********************************************************************************/

SEL CURRENT_TIMESTAMP;

 *** Query completed. One row found. One column returned. 
 *** Total elapsed time was 1 second.

            Current TimeStamp(6)
2023-01-28 00:48:14.220000-05:00

+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

    
LOGOFF;
 *** You are now logged off from the DBC.
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
QUIT 0;
 *** Exiting BTEQ...
 *** RC (return code) = 0 
  ***********************************************
  ***  J093168_KPIGRP03   ***
  ***            TERMINO PROCESO OK           ***
  ***********************************************
